<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="template" content="_Code.htt" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="vi-VN" />
<meta name="robots" content="NOODP" />
<meta name="generator" content="Adobe RoboHelp 11" />
<title>code_CreateNewCard</title>
<link rel="StyleSheet" href="..\..\code.style.css" type="text/css" />
</head>

<body>
<?rh-placeholder type="header" ?>
<!-- HTML generated using hilite.me --><div>
	<pre style="margin: 0;">
<span style="color: #008000;">/// &lt;summary&gt;</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #008000;">/// Tạo copy của MemberCardDetail đang chọn, và tính ngày ExpiryDate cho Card mới này</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #008000;">/// &lt;list type=&quot;bullet&quot;&gt;</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #008000;">/// &#160;&#160;&#160;&#160;&lt;item&gt;Nếu Renew trong khoảng từ ngày 1 - ngày 15 sẽ lấy ngày 28 tháng đó + 1 năm.&lt;/item&gt;</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #008000;">/// &#160;&#160;&#160;&#160;&lt;item&gt;Nếu sau ngày 15 thì lấy ngày 15 của tháng sau + 1 năm.&lt;/item&gt;</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #008000;">/// &lt;/list&gt;</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #008000;">/// &lt;/summary&gt;</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #008000;">/// &lt;returns&gt;&lt;/returns&gt;</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000ff;">private</span> MemberCard CreateNewCard()
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #2b91af;">var</span> newCard = _controller.MemberCardDetail.DeepCopy();
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;newCard.StatusId = 5;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000ff;">try</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #008000;">//Create copy of _controller.MemberCardDetail</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #2b91af;">int</span> oldCardType = newCard.CardTypeId;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;newCard.SoldDate = DateTime.Today.Date;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #008000;">//Tính ExpiryDate</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #008000;">//Nếu Renew trong khoảng từ ngày 1 - ngày 15 sẽ lấy ngày 28 tháng đó + 1 năm.</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #008000;">//Nếu sau ngày 15 thì lấy ngày 15 của tháng sau + 1 năm.</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000ff;">if</span> (DateTime.Today.Date.Day &lt;= 15)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;newCard.ExpiryDate = <span style="color: #0000ff;">new</span> DateTime(DateTime.Now.Year + 1, DateTime.Now.Month, 28);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000ff;">else</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #2b91af;">int</span> y = DateTime.Now.Year + 1;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #2b91af;">int</span> m = DateTime.Now.Month + 1;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000ff;">if</span> (m &gt; 12)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;y++;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;m = 1;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;newCard.ExpiryDate = <span style="color: #0000ff;">new</span> DateTime(y, m, 15);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;newCard.StatusId = (<span style="color: #2b91af;">int</span>)GlobalEnum.CardStatusEnum.Issused;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;newCard.RenewalDate = DateTime.Today.Date;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #2b91af;">var</span> findRewnewRange = MasCardTypes.FirstOrDefault(type =&gt; type.CardTypeId == oldCardType);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000ff;">if</span> (findRewnewRange != <span style="color: #0000ff;">null</span> &amp;&amp; findRewnewRange.RenewRange.HasValue)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;newCard.CardTypeId = findRewnewRange.RenewRange.Value;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #2b91af;">var</span> findCtDesc = MasCardTypes.FirstOrDefault(type =&gt; type.CardTypeId == newCard.CardTypeId);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000ff;">if</span> (findCtDesc != <span style="color: #0000ff;">null</span>)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;newCard.MasCardType =findCtDesc;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #2b91af;">var</span> findNewProg = MasProgrammes.FirstOrDefault(type =&gt; type.ProgrammeId == findCtDesc.ProgrammeId);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000ff;">if</span> (findNewProg != <span style="color: #0000ff;">null</span>)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;newCard.ProgrammeId = findNewProg.ProgrammeId;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;newCard.MasProgramme.Description = findNewProg.Description;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000ff;">catch</span> (Exception ex)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Logger.Log(<span style="color: #a31515;">&quot;CreateNewCard method in RenewCardVm has error&quot;</span>,ex);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;ShowToast(FriendlyMessages.TOAST_Share_Error_Title,ex.Message);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000ff;">return</span> newCard;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}</pre>
</div>
</body>
</html>
