<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="template" content="_Code.htt" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Language" content="vi-VN" />
<meta name="generator" content="Adobe RoboHelp 11" />
<title>proc_GetMaxCardIDByCardType</title>
<link rel="StyleSheet" href="..\..\code.style.css" type="text/css" />
</head>

<body>
<?rh-placeholder type="header" ?>
<br />
<div>
	<pre style="margin: 20px;">
USE [Membership]<span style="color: #0000aa;">
GO</span><span style="color: #aaaaaa; font-style: italic;">
/****** Object: &#160;StoredProcedure [dbo].[GetMaxCardIDByCardType] &#160;&#160;&#160;Script Date: 7/31/2014 2:50:07 PM ******/</span><span style="color: #0000aa;">
SET</span> ANSI_NULLS <span style="color: #0000aa;">ON</span><span style="color: #0000aa;">
GO</span><span style="color: #0000aa;">
SET</span> QUOTED_IDENTIFIER <span style="color: #0000aa;">ON</span><span style="color: #0000aa;">
GO</span><span style="color: #aaaaaa; font-style: italic;">
-- =============================================</span><span style="color: #aaaaaa; font-style: italic;">
-- Author: &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;Author,,Name&gt;</span><span style="color: #aaaaaa; font-style: italic;">
-- Create date: &lt;Create Date,,&gt;</span><span style="color: #aaaaaa; font-style: italic;">
-- Description: &lt;Description,,&gt;</span><span style="color: #aaaaaa; font-style: italic;">
-- =============================================</span><span style="color: #0000aa;">
ALTER</span> <span style="color: #0000aa;">PROCEDURE</span> [dbo].[GetMaxCardIDByCardType]
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;@ProgrammeID <span style="color: #00aaaa;">INT</span>,
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;@CardTypeID <span style="color: #00aaaa;">INT</span>,
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;@<span style="color: #0000aa;">Mode</span> <span style="color: #00aaaa;">INT</span> <span style="color: #aaaaaa; font-style: italic;">--1. Renew, 2. Replace, 3. Refund or 4. Printing Card</span><span style="color: #0000aa;">
AS</span><span style="color: #0000aa;">
BEGIN</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #aaaaaa; font-style: italic;">--TEST:</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #aaaaaa; font-style: italic;">--declare @ProgrammeID int=1</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #aaaaaa; font-style: italic;">--declare @CardTypeID int =1</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #aaaaaa; font-style: italic;">--declare @Mode int =4</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">DECLARE</span> @<span style="color: #0000aa;">RESULT</span> <span style="color: #00aaaa;">VARCHAR</span>(<span style="color: #009999;">20</span>)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">DECLARE</span> @newCardTypeId <span style="color: #00aaaa;">INT</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">DECLARE</span> @lenghtNo <span style="color: #00aaaa;">INT</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">DECLARE</span> @errMsg <span style="color: #00aaaa;">VARCHAR</span>(<span style="color: #009999;">250</span>)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">SET</span> @newCardTypeId=(
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">CASE</span> @<span style="color: #0000aa;">Mode</span> 
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">WHEN</span> <span style="color: #009999;">1</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">THEN</span> &#160;(<span style="color: #0000aa;">SELECT</span> Renew_Range <span style="color: #0000aa;">FROM</span> MAS_CardTypes <span style="color: #0000aa;">WHERE</span> CardType_ID = @CardTypeId)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">WHEN</span> <span style="color: #009999;">2</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">THEN</span> (<span style="color: #0000aa;">SELECT</span> Replace_Range <span style="color: #0000aa;">FROM</span> MAS_CardTypes <span style="color: #0000aa;">WHERE</span> CardType_ID = @CardTypeId)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">WHEN</span> <span style="color: #009999;">3</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">THEN</span> (<span style="color: #0000aa;">SELECT</span> Refund_Range <span style="color: #0000aa;">FROM</span> MAS_CardTypes <span style="color: #0000aa;">WHERE</span> CardType_ID = @CardTypeId)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">WHEN</span> <span style="color: #009999;">4</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">THEN</span> &#160;@CardTypeId
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">END</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">SET</span> @lenghtNo=(<span style="color: #0000aa;">SELECT</span> LengthNo <span style="color: #0000aa;">FROM</span> MAS_CardTypes <span style="color: #0000aa;">WHERE</span> CardType_ID = @newCardTypeId)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">DECLARE</span> @newProgrammeId <span style="color: #00aaaa;">INT</span> = (<span style="color: #0000aa;">SELECT</span> Programme_ID <span style="color: #0000aa;">FROM</span> MAS_CardTypes <span style="color: #0000aa;">WHERE</span> CardType_ID=@newCardTypeId)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print <span style="color: #aa5500;">'New Card TYpe ID: '</span>+<span style="color: #0000aa;">CAST</span>(@newCardTypeId <span style="color: #0000aa;">AS</span> <span style="color: #00aaaa;">VARCHAR</span>)<span style="color: #aaaaaa; font-style: italic;">--//(**)</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print <span style="color: #aa5500;">'New Prog ID: '</span>+<span style="color: #0000aa;">CAST</span>(@newProgrammeId <span style="color: #0000aa;">AS</span> <span style="color: #00aaaa;">VARCHAR</span>)<span style="color: #aaaaaa; font-style: italic;">--//(**)</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #aaaaaa; font-style: italic;">--Nếu @newCardTypeId (tức các xxx_Range) chưa định ngĩa thì quăng error</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;IF @newCardTypeId <span style="color: #0000aa;">IS</span> <span style="color: #0000aa;">NULL</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">BEGIN</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">SET</span> @errMsg =<span style="color: #aa5500;">'The '</span>+ <span style="color: #0000aa;">CASE</span> @<span style="color: #0000aa;">Mode</span> <span style="color: #0000aa;">WHEN</span> <span style="color: #009999;">1</span> <span style="color: #0000aa;">THEN</span> <span style="color: #aa5500;">'Renew Range'</span> <span style="color: #0000aa;">WHEN</span> <span style="color: #009999;">2</span> <span style="color: #0000aa;">THEN</span> <span style="color: #aa5500;">'Replace Range'</span> <span style="color: #0000aa;">WHEN</span> <span style="color: #009999;">3</span> <span style="color: #0000aa;">THEN</span> <span style="color: #aa5500;">'Refund Range'</span> <span style="color: #0000aa;">END</span> +<span style="color: #aa5500;">' is not defined'</span>;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #aaaaaa; font-style: italic;">--THROW 50001,16,1,@errMsg)</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;throw <span style="color: #009999;">50001</span>,@errMsg,<span style="color: #009999;">1</span> <span style="color: #aaaaaa; font-style: italic;">-- Nhhớ có ';' trước bất kỳ câu lệnh nào trước lệnh throw này</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">END</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #aaaaaa; font-style: italic;">--Nếu @newCardTypeId (tức các xxx_Range) có định ngĩa nhưng mà không trùng với bất kỳ CardType_ID nào thì quăng error</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;IF <span style="color: #0000aa;">NOT</span> <span style="color: #0000aa;">EXISTS</span> (<span style="color: #0000aa;">SELECT</span> * <span style="color: #0000aa;">FROM</span> MAS_CardTypes <span style="color: #0000aa;">WHERE</span> CardType_ID=@newCardTypeId)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">BEGIN</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">SET</span> @errMsg =<span style="color: #aa5500;">'The '</span>+ <span style="color: #0000aa;">CASE</span> @<span style="color: #0000aa;">Mode</span> <span style="color: #0000aa;">WHEN</span> <span style="color: #009999;">1</span> <span style="color: #0000aa;">THEN</span> <span style="color: #aa5500;">'Renew Range'</span> <span style="color: #0000aa;">WHEN</span> <span style="color: #009999;">2</span> <span style="color: #0000aa;">THEN</span> <span style="color: #aa5500;">'Replace Range'</span> <span style="color: #0000aa;">WHEN</span> <span style="color: #009999;">3</span> <span style="color: #0000aa;">THEN</span> <span style="color: #aa5500;">'Refund Range '</span> <span style="color: #0000aa;">END</span> +<span style="color: #0000aa;">CAST</span>(@newCardTypeId <span style="color: #0000aa;">AS</span> <span style="color: #00aaaa;">VARCHAR</span>)+<span style="color: #aa5500;">' not found Card Type ID reference'</span>;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;throw <span style="color: #009999;">50001</span>,@errMsg,<span style="color: #009999;">1</span> <span style="color: #aaaaaa; font-style: italic;">-- Nhhớ có ';' trước bất kỳ câu lệnh nào trước lệnh throw này</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">END</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #aaaaaa; font-style: italic;">--Tìm index của 1 ký tự trong Starting_Card_ID của 1 CardType</span>
&#160;&#160;&#160;&#160;<span style="color: #0000aa;">DECLARE</span> @startingCardID <span style="color: #00aaaa;">VARCHAR</span>(<span style="color: #009999;">20</span>)=(
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">SELECT</span> Starting_Card_ID
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">FROM</span> MAS_CardTypes
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">WHERE</span> CardType_ID = @newCardTypeId)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
&#160;<span style="color: #aaaaaa; font-style: italic;">-- &#160;declare @indexOfNonNumber int=</span>
&#160;<span style="color: #aaaaaa; font-style: italic;">-- &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(</span>
&#160;<span style="color: #aaaaaa; font-style: italic;">-- &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;SELECT patindex('%[^0-9]%', @startingCardID))</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #aaaaaa; font-style: italic;">----Nếu index=0, tức Starting_Card_ID hoàn toàn là chữ số</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;IF (<span style="color: #0000aa;">SELECT</span> <span style="color: #0000aa;">MAX</span>(<span style="color: #0000aa;">RIGHT</span>(m.Card_ID,@lenghtNo))
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">FROM</span> MemberCards m
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">WHERE</span> m.Programme_ID = @newProgrammeId
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">AND</span> m.CardType_ID = @newCardTypeId) <span style="color: #0000aa;">IS</span> <span style="color: #0000aa;">NULL</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">BEGIN</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">SET</span> @<span style="color: #0000aa;">RESULT</span>=dbo.func_IncreaseCardId((<span style="color: #0000aa;">SELECT</span> ct.Starting_Card_ID <span style="color: #0000aa;">FROM</span> MAS_CardTypes ct <span style="color: #0000aa;">WHERE</span> ct.CardType_ID = @newCardTypeId)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;,@lenghtNo)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print <span style="color: #aa5500;">'Point A'</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">END</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">ELSE</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">BEGIN</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">DECLARE</span> @<span style="color: #0000aa;">KEY</span> NVARCHAR(<span style="color: #009999;">20</span>)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;IF @newCardTypeId=<span style="color: #009999;">1</span> <span style="color: #0000aa;">OR</span> @newCardTypeId=<span style="color: #009999;">3</span> <span style="color: #0000aa;">OR</span> @newCardTypeId=<span style="color: #009999;">4</span><span style="color: #0000aa;">OR</span> @newCardTypeId=<span style="color: #009999;">111</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">BEGIN</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">SET</span> @<span style="color: #0000aa;">KEY</span>=(<span style="color: #0000aa;">SELECT</span> <span style="color: #0000aa;">MAX</span>(<span style="color: #0000aa;">RIGHT</span>(Card_ID, @lenghtNo)) <span style="color: #0000aa;">AS</span> maxx
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">FROM</span> MemberCards 
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">WHERE</span> Programme_ID = @newProgrammeId <span style="color: #0000aa;">AND</span> CardType_ID = @newCardTypeId <span style="color: #0000aa;">AND</span> Card_ID <span style="color: #0000aa;">NOT</span> <span style="color: #0000aa;">LIKE</span> <span style="color: #aa5500;">'C%'</span><span style="color: #0000aa;">AND</span> Card_ID <span style="color: #0000aa;">NOT</span> <span style="color: #0000aa;">LIKE</span> <span style="color: #aa5500;">'B%'</span><span style="color: #0000aa;">AND</span> Card_ID <span style="color: #0000aa;">NOT</span> <span style="color: #0000aa;">LIKE</span> <span style="color: #aa5500;">'H%'</span>)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">END</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">ELSE</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">BEGIN</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">SET</span> @<span style="color: #0000aa;">KEY</span> =(<span style="color: #0000aa;">SELECT</span> <span style="color: #0000aa;">MAX</span>(<span style="color: #0000aa;">RIGHT</span>(Card_ID, @lenghtNo)) <span style="color: #0000aa;">AS</span> maxx
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">FROM</span> MemberCards
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">WHERE</span> Programme_ID = @newProgrammeId <span style="color: #0000aa;">AND</span> CardType_ID = @newCardTypeId)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">END</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">DECLARE</span> @maxCardId <span style="color: #00aaaa;">VARCHAR</span>(<span style="color: #009999;">20</span>)=(<span style="color: #0000aa;">SELECT</span> Card_ID 
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">FROM</span> MemberCards m 
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">WHERE</span> m.Programme_ID = @newProgrammeId 
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">AND</span> m.CardType_ID = @newCardTypeId 
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">AND</span> m.Card_ID <span style="color: #0000aa;">LIKE</span> <span style="color: #aa5500;">'%'</span>+@<span style="color: #0000aa;">KEY</span>)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">SET</span> @<span style="color: #0000aa;">RESULT</span>=dbo.func_IncreaseCardId(@maxCardId, @lenghtNo)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #aaaaaa; font-style: italic;">--//Nếu MaxCard ID sau khi tính lớn hơn EndingCardId throw error</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;IF <span style="color: #0000aa;">CAST</span>(<span style="color: #0000aa;">RIGHT</span>(@<span style="color: #0000aa;">RESULT</span>,@lenghtNo) <span style="color: #0000aa;">AS</span> <span style="color: #00aaaa;">BIGINT</span>) &gt; <span style="color: #0000aa;">CAST</span>(<span style="color: #0000aa;">RIGHT</span>((<span style="color: #0000aa;">SELECT</span> ct.Ending_Card_ID <span style="color: #0000aa;">FROM</span> MAS_CardTypes ct <span style="color: #0000aa;">WHERE</span> ct.CardType_ID = @newCardTypeId),@lenghtNo) <span style="color: #0000aa;">AS</span> <span style="color: #00aaaa;">BIGINT</span>)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">BEGIN</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">SET</span> @errMsg =<span style="color: #aa5500;">'Card out of range'</span>;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;throw <span style="color: #009999;">50001</span>,@errMsg,<span style="color: #009999;">1</span> <span style="color: #aaaaaa; font-style: italic;">-- Nhhớ có ';' trước bất kỳ câu lệnh nào trước lệnh throw này</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">END</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">END</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;IF dbo.func_CheckCardIdInStartEnd(<span style="color: #0000aa;">CAST</span>(<span style="color: #0000aa;">CAST</span>(<span style="color: #0000aa;">RIGHT</span>(@<span style="color: #0000aa;">RESULT</span>, @lenghtNo) <span style="color: #0000aa;">AS</span> <span style="color: #00aaaa;">BIGINT</span>)-<span style="color: #009999;">1</span> <span style="color: #0000aa;">AS</span> <span style="color: #00aaaa;">VARCHAR</span>))=<span style="color: #009999;">0</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">BEGIN</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">SET</span> @errMsg=<span style="color: #aa5500;">'In DB exist the Card ID: '</span>+<span style="color: #0000aa;">CAST</span>(<span style="color: #0000aa;">CAST</span>(@<span style="color: #0000aa;">RESULT</span> <span style="color: #0000aa;">AS</span> <span style="color: #00aaaa;">BIGINT</span>)-<span style="color: #009999;">1</span> <span style="color: #0000aa;">AS</span> <span style="color: #00aaaa;">VARCHAR</span>)
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;+<span style="color: #aa5500;">', which have Card Type ID conflict with Starting Card ID and Ending Card ID'</span>;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;throw <span style="color: #009999;">50001</span>,@errMsg,<span style="color: #009999;">1</span> <span style="color: #aaaaaa; font-style: italic;">-- Nhhớ có ';' trước bất kỳ câu lệnh nào trước lệnh throw này</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">END</span>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color: #0000aa;">SELECT</span> @<span style="color: #0000aa;">RESULT</span><span style="color: #0000aa;">
END</span></pre>
</div>
</body>
</html>
